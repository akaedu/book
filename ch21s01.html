<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>1. 预处理的步骤</title><link rel="stylesheet" href="styles.css" type="text/css" /><meta name="generator" content="DocBook XSL Stylesheets V1.73.2" /><link rel="start" href="index.html" title="Linux C编程一站式学习" /><link rel="up" href="ch21.html" title="第 21 章 预处理" /><link rel="prev" href="ch21.html" title="第 21 章 预处理" /><link rel="next" href="ch21s02.html" title="2. 宏定义" /></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">1. 预处理的步骤</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="ch21.html">上一页</a> </td><th width="60%" align="center">第 21 章 预处理</th><td width="20%" align="right"> <a accesskey="n" href="ch21s02.html">下一页</a></td></tr></table><hr /></div><div class="sect1" lang="zh-cn" xml:lang="zh-cn"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="id2796242"></a>1. 预处理的步骤</h2></div></div></div><p>现在我们全面了解一下C编译器做语法解析之前的预处理步骤：</p><p>1、把<a class="xref" href="ch02s02.html#expr.constant">第 2 节 “常量”</a>提到过的三连符替换成相应的单字符。</p><p>2、把用<code class="literal">\</code>字符续行的多行代码接成一行。例如：</p><pre class="programlisting">#define STR "hello, "\
		"world"</pre><p>经过这个预处理步骤之后接成一行：</p><pre class="programlisting">#define STR "hello, "		"world"</pre><p>这种续行的写法要求<code class="literal">\</code>后面紧跟换行，中间不能有其它空白字符。</p><p>3、把注释（不管是单行注释还是多行注释）都替换成一个空格。</p><p>4、经过以上两步之后去掉了一些换行，有的换行在续行过程中去掉了，有的换行在多行注释之中，也随着注释一起去掉了，剩下的代码行称为逻辑代码行。然后预处理器把逻辑代码行划分成Token和空白字符，这时的Token称为预处理Token，包括标识符、整数常量、浮点数常量、字符常量、字符串、运算符和其它符号。继续上面的例子，两个源代码行被接成一个逻辑代码行，然后这个逻辑代码行被划分成Token和空白字符：<code class="literal">#</code>，<code class="literal">define</code>，空格，<code class="literal">STR</code>，空格，<code class="literal">"hello, "</code>，Tab，Tab，<code class="literal">"world"</code>。</p><p>5、在Token中识别出预处理指示，做相应的预处理动作，如果遇到<code class="literal">#include</code>预处理指示，则把相应的源文件包含进来，并对源文件做以上1-4步预处理。如果遇到宏定义则做宏展开。</p><p>我们早在<a class="xref" href="ch08s02.html#array.statistic">第 2 节 “数组应用实例：统计随机数”</a>就认识了预处理指示这个概念，现在给出它的严格定义。一条预处理指示由一个逻辑代码行组成，以<code class="literal">#</code>开头，后面跟若干个预处理Token，在预处理指示中允许使用的空白字符只有空格和Tab。</p><p>6、找出字符常量或字符串中的转义序列，用相应的字节来替换它，比如把<code class="literal">\n</code>替换成字节0x0a。</p><p>7、把相邻的字符串连接起来。继续上面的例子，如果代码中有：</p><pre class="programlisting">printf(
	STR);</pre><p>经过第4步处理划分成以下Token：<code class="literal">printf</code>，<code class="literal">(</code>，换行，Tab，<code class="literal">STR</code>，<code class="literal">)</code>，<code class="literal">;</code>，换行。经过第5步宏展开后变成以下Token：<code class="literal">printf</code>，<code class="literal">(</code>，换行，Tab，<code class="literal">"hello, "</code>，Tab，Tab，<code class="literal">"world"</code>，<code class="literal">)</code>，<code class="literal">;</code>，换行。然后把相邻的字符串连接起来，变成以下Token：<code class="literal">printf</code>，<code class="literal">(</code>，换行，Tab，<code class="literal">"hello, world"</code>，<code class="literal">)</code>，<code class="literal">;</code>，换行。</p><p>8、经过以上处理之后，把空白字符丢掉，把Token交给C编译器做语法解析，这时就不再是预处理Token，而称为C Token了。这里丢掉的空白字符包括空格、换行、水平Tab、垂直Tab、分页符。继续上面的例子，最后交给C编译器做语法解析的Token是：<code class="literal">printf</code>，<code class="literal">(</code>，<code class="literal">"hello, world"</code>，<code class="literal">)</code>，<code class="literal">;</code>。注意，把一个预处理指示写成多行要用<code class="literal">\</code>续行，因为根据定义，一条预处理指示只能由一个逻辑代码行组成，而把C代码写成多行则不需要用<code class="literal">\</code>续行，因为换行在C代码中只不过是一种空白字符，在做语法解析时所有空白字符都已经丢掉了。</p></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="ch21.html">上一页</a> </td><td width="20%" align="center"><a accesskey="u" href="ch21.html">上一级</a></td><td width="40%" align="right"> <a accesskey="n" href="ch21s02.html">下一页</a></td></tr><tr><td width="40%" align="left" valign="top">第 21 章 预处理 </td><td width="20%" align="center"><a accesskey="h" href="index.html">起始页</a></td><td width="40%" align="right" valign="top"> 2. 宏定义</td></tr></table></div></body></html>
