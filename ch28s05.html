<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>5. lseek</title><link rel="stylesheet" href="styles.css" type="text/css" /><meta name="generator" content="DocBook XSL Stylesheets V1.73.2" /><link rel="start" href="index.html" title="Linux C编程一站式学习" /><link rel="up" href="ch28.html" title="第 28 章 文件与I/O" /><link rel="prev" href="ch28s04.html" title="4. read/write" /><link rel="next" href="ch28s06.html" title="6. fcntl" /></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">5. lseek</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="ch28s04.html">上一页</a> </td><th width="60%" align="center">第 28 章 文件与I/O</th><td width="20%" align="right"> <a accesskey="n" href="ch28s06.html">下一页</a></td></tr></table><hr /></div><div class="sect1" lang="zh-cn" xml:lang="zh-cn"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="id2852751"></a>5. lseek</h2></div></div></div><p>每个打开的文件都记录着当前读写位置，打开文件时读写位置是0，表示文件开头，通常读写多少个字节就会将读写位置往后移多少个字节。但是有一个例外，如果以<code class="literal">O_APPEND</code>方式打开，每次写操作都会在文件末尾追加数据，然后将读写位置移到新的文件末尾。<code class="literal">lseek</code>和标准I/O库的<code class="literal">fseek</code>函数类似，可以移动当前读写位置（或者叫偏移量）。</p><pre class="programlisting">#include &lt;sys/types.h&gt;
#include &lt;unistd.h&gt;

off_t lseek(int fd, off_t offset, int whence);</pre><p>参数<code class="literal">offset</code>和<code class="literal">whence</code>的含义和<code class="literal">fseek</code>函数完全相同。只不过第一个参数换成了文件描述符。和<code class="literal">fseek</code>一样，偏移量允许超过文件末尾，这种情况下对该文件的下一次写操作将延长文件，中间空洞的部分读出来都是0。</p><p>若<code class="literal">lseek</code>成功执行，则返回新的偏移量，因此可用以下方法确定一个打开文件的当前偏移量：</p><pre class="programlisting">off_t currpos;
currpos = lseek(fd, 0, SEEK_CUR);</pre><p>这种方法也可用来确定文件或设备是否可以设置偏移量，常规文件都可以设置偏移量，而设备一般是不可以设置偏移量的。如果设备不支持<code class="literal">lseek</code>，则<code class="literal">lseek</code>返回-1，并将<code class="literal">errno</code>设置为<code class="literal">ESPIPE</code>。注意<code class="literal">fseek</code>和<code class="literal">lseek</code>在返回值上有细微的差别，<code class="literal">fseek</code>成功时返回0失败时返回-1，要返回当前偏移量需调用<code class="literal">ftell</code>，而<code class="literal">lseek</code>成功时返回当前偏移量失败时返回-1。</p></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="ch28s04.html">上一页</a> </td><td width="20%" align="center"><a accesskey="u" href="ch28.html">上一级</a></td><td width="40%" align="right"> <a accesskey="n" href="ch28s06.html">下一页</a></td></tr><tr><td width="40%" align="left" valign="top">4. read/write </td><td width="20%" align="center"><a accesskey="h" href="index.html">起始页</a></td><td width="40%" align="right" valign="top"> 6. fcntl</td></tr></table></div></body></html>
